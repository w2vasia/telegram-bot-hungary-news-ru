# News Tags Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add Russian hashtag categories to each Telegram post, extracted from RSS feed metadata or classified by Gemma when RSS has no categories.

**Architecture:** New `bot/tagger.py` extracts raw categories from `Article.raw_categories` (populated in feeds.py from RSS), translates them to single Russian words via Gemma, falls back to Gemma classification if no categories. `poster.py` inserts tags between summary and link. `scheduler.py` calls tagger and passes tags to poster.

**Tech Stack:** Same as existing — feedparser (RSS category extraction), httpx + Ollama (Gemma translation/classification), python-telegram-bot.

---

### Task 1: Add `raw_categories` to Article dataclass

**Files:**
- Modify: `bot/feeds.py`
- Modify: `tests/test_feeds.py`

**Step 1: Write failing test**

Add to `tests/test_feeds.py`:

```python
def test_article_has_raw_categories():
    a = Article(title="T", url="http://x.com", source="MTI", raw_categories=["belfold", "gazdasag"])
    assert a.raw_categories == ["belfold", "gazdasag"]

def test_article_raw_categories_defaults_to_empty():
    a = Article(title="T", url="http://x.com", source="MTI")
    assert a.raw_categories == []
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_feeds.py -v
```
Expected: TypeError (unexpected keyword argument `raw_categories`).

**Step 3: Update `Article` dataclass in `bot/feeds.py`**

Change:
```python
@dataclass
class Article:
    title: str
    url: str
    source: str
```
To:
```python
from dataclasses import dataclass, field

@dataclass
class Article:
    title: str
    url: str
    source: str
    raw_categories: list[str] = field(default_factory=list)
```

Also update `fetch_feed` to populate `raw_categories` from feedparser entry tags:

```python
async def fetch_feed(source: dict) -> list[Article]:
    feed = feedparser.parse(source["url"])
    articles = []
    for entry in feed.entries:
        url = entry.get("link", "")
        title = entry.get("title", "")
        if url and title:
            raw_categories = [t.term for t in entry.get("tags", []) if t.get("term")]
            articles.append(Article(
                title=title,
                url=url,
                source=source["name"],
                raw_categories=raw_categories,
            ))
    return articles
```

**Step 4: Run tests to verify they pass**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_feeds.py -v
```
Expected: all tests pass.

**Step 5: Commit**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && git add bot/feeds.py tests/test_feeds.py && git commit -m "feat: add raw_categories to Article from RSS tags"
```

---

### Task 2: Tagger module

**Files:**
- Create: `bot/tagger.py`
- Create: `tests/test_tagger.py`

**Step 1: Write failing tests**

```python
# tests/test_tagger.py
import pytest
from unittest.mock import AsyncMock
from bot.tagger import get_tags
from bot.feeds import Article

@pytest.mark.asyncio
async def test_uses_rss_categories_when_available():
    mock_translator = AsyncMock()
    mock_translator.translate = AsyncMock(return_value="политика экономика")
    article = Article(title="Teszt", url="http://x.com", source="HVG",
                      raw_categories=["belfold", "gazdasag"])
    tags = await get_tags(article, mock_translator)
    assert tags == ["#политика", "#экономика"]
    mock_translator.translate.assert_called_once()

@pytest.mark.asyncio
async def test_falls_back_to_classification_when_no_categories():
    mock_translator = AsyncMock()
    mock_translator.translate = AsyncMock(return_value="политика")
    article = Article(title="Valami hír", url="http://x.com", source="444",
                      raw_categories=[])
    tags = await get_tags(article, mock_translator)
    assert tags == ["#политика"]
    mock_translator.translate.assert_called_once()

@pytest.mark.asyncio
async def test_returns_empty_on_translator_error():
    mock_translator = AsyncMock()
    mock_translator.translate = AsyncMock(side_effect=Exception("timeout"))
    article = Article(title="Hír", url="http://x.com", source="Telex",
                      raw_categories=[])
    tags = await get_tags(article, mock_translator)
    assert tags == []

@pytest.mark.asyncio
async def test_max_three_tags():
    mock_translator = AsyncMock()
    mock_translator.translate = AsyncMock(return_value="политика экономика спорт культура")
    article = Article(title="T", url="http://x.com", source="HVG",
                      raw_categories=["a", "b", "c", "d"])
    tags = await get_tags(article, mock_translator)
    assert len(tags) <= 3

@pytest.mark.asyncio
async def test_tags_are_lowercase_hashtags():
    mock_translator = AsyncMock()
    mock_translator.translate = AsyncMock(return_value="Политика")
    article = Article(title="T", url="http://x.com", source="HVG",
                      raw_categories=["belfold"])
    tags = await get_tags(article, mock_translator)
    assert all(t.startswith("#") for t in tags)
    assert all(t == t.lower() for t in tags)
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_tagger.py -v
```
Expected: ImportError (bot.tagger not found).

**Step 3: Create `bot/tagger.py`**

```python
import logging
from bot.feeds import Article
from bot.translator.base import Translator

logger = logging.getLogger(__name__)

MAX_TAGS = 3

def _format_tags(raw: str) -> list[str]:
    words = raw.lower().split()
    tags = []
    for w in words:
        w = w.strip(".,!?;:")
        if w:
            tags.append(f"#{w}")
    return tags[:MAX_TAGS]

async def get_tags(article: Article, translator: Translator) -> list[str]:
    try:
        if article.raw_categories:
            categories_str = " ".join(article.raw_categories[:MAX_TAGS])
            prompt = (
                f"Translate these Hungarian category names to single Russian words "
                f"suitable as hashtags, space-separated. Return only the words: {categories_str}"
            )
        else:
            prompt = (
                f"Classify this Hungarian news headline into 1-3 single Russian words "
                f"(e.g. политика, экономика, спорт, культура, технологии, общество, мир). "
                f"Return only the words space-separated: {article.title}"
            )
        result = await translator.translate(prompt, source_lang="HU", target_lang="RU")
        return _format_tags(result)
    except Exception as e:
        logger.warning(f"Failed to get tags for {article.url}: {e}")
        return []
```

**Step 4: Run tests to verify they pass**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_tagger.py -v
```
Expected: 5 passed.

**Step 5: Commit**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && git add bot/tagger.py tests/test_tagger.py && git commit -m "feat: tagger module with rss category extraction and gemma fallback"
```

---

### Task 3: Update Poster to include tags

**Files:**
- Modify: `bot/poster.py`
- Modify: `tests/test_poster.py`

**Step 1: Write failing tests**

Add to `tests/test_poster.py`:

```python
@pytest.mark.asyncio
async def test_poster_includes_tags_when_provided():
    mock_bot = MagicMock()
    mock_bot.send_message = AsyncMock()
    poster = Poster(bot=mock_bot, channel_id="@testchannel")
    await poster.post(summary="Новость", url="https://example.com",
                      tags=["#политика", "#экономика"])
    call_kwargs = mock_bot.send_message.call_args.kwargs
    assert "#политика" in call_kwargs["text"]
    assert "#экономика" in call_kwargs["text"]

@pytest.mark.asyncio
async def test_poster_no_tags_line_when_empty():
    mock_bot = MagicMock()
    mock_bot.send_message = AsyncMock()
    poster = Poster(bot=mock_bot, channel_id="@testchannel")
    await poster.post(summary="Новость", url="https://example.com", tags=[])
    call_kwargs = mock_bot.send_message.call_args.kwargs
    assert "##" not in call_kwargs["text"]
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_poster.py -v
```
Expected: TypeError (unexpected keyword argument `tags`).

**Step 3: Update `bot/poster.py`**

```python
from telegram import Bot

class Poster:
    def __init__(self, bot: Bot, channel_id: str):
        self._bot = bot
        self._channel_id = channel_id

    async def post(self, summary: str, url: str, tags: list[str] | None = None):
        tags_line = ("\n" + " ".join(tags)) if tags else ""
        text = f"{summary}{tags_line}\n\n<a href='{url}'>Читать полностью</a>"
        await self._bot.send_message(
            chat_id=self._channel_id,
            text=text,
            parse_mode="HTML",
            disable_web_page_preview=True,
        )
```

**Step 4: Run tests to verify they pass**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/test_poster.py -v
```
Expected: 4 passed.

**Step 5: Commit**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && git add bot/poster.py tests/test_poster.py && git commit -m "feat: poster supports optional tags between summary and link"
```

---

### Task 4: Wire tagger into scheduler

**Files:**
- Modify: `bot/scheduler.py`

No new tests (integration glue). Existing tests cover the individual components.

**Step 1: Update `bot/scheduler.py`**

```python
import asyncio
import logging
from bot.db import Database
from bot.feeds import fetch_all
from bot.summarizer import summarize
from bot.translator.base import Translator
from bot.poster import Poster
from bot.tagger import get_tags

logger = logging.getLogger(__name__)

async def run_once(db: Database, translator: Translator, poster: Poster):
    articles = await fetch_all()
    for article in articles:
        if await db.is_seen(article.url):
            continue
        try:
            translated = await translator.translate(article.title)
            summary = summarize(translated)
            tags = await get_tags(article, translator)
            await poster.post(summary=summary, url=article.url, tags=tags)
            await db.mark_seen(article.url)
            logger.info(f"Posted: {article.url}")
            await asyncio.sleep(3)  # avoid Telegram flood control
        except Exception as e:
            logger.error(f"Failed to process {article.url}: {e}")
```

**Step 2: Run full test suite**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose run --rm bot pytest tests/ -v
```
Expected: all tests pass.

**Step 3: Commit**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && git add bot/scheduler.py && git commit -m "feat: wire tagger into scheduler"
```

---

### Task 5: Smoke test with live bot

**Step 1: Restart bot**

```bash
cd /Users/wasiliy/Documents/Projects/telegram-bot-hungary-news-ru && docker compose down && docker compose up -d
```

**Step 2: Watch logs**

```bash
docker compose logs -f
```
Expected: logs show `Posted:` lines without errors. Check `@hungary_news_ru` — new posts should have `#hashtag` lines between summary and link.

**Step 3: Verify in channel**

Open `@hungary_news_ru` and confirm post format:
```
Перевод заголовка статьи...

#политика #экономика

Читать полностью
```
